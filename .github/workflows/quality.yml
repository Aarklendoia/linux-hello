name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  format:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      
      - name: Check formatting
        run: cargo fmt --all -- --check
  
  lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libssl-dev \
            libpam0g-dev \
            pkg-config
      
      - name: Run clippy
        run: cargo clippy --all --all-targets -- -D warnings
  
  security:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install security tools
        run: cargo install cargo-audit
      
      - name: Run cargo-audit
        # Note: The following advisories are ignored:
        # RUSTSEC-2023-0071 (rsa timing sidechannel) - transitive via sqlx, low practical risk
        # RUSTSEC-2024-0436 (paste unmaintained) - non-critical, only used in sqlx macros
        run: cargo audit --ignore RUSTSEC-2023-0071 --ignore RUSTSEC-2024-0436

